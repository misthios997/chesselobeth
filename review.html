<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Review</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #ffd700; --bg: #1a1a1a; --panel: #2d2d2d; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .header { width: 100%; max-width: 450px; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .btn-back { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        #board { width: 100%; max-width: 400px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-nav { background: var(--panel); border: 1px solid #444; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .info-box { background: var(--panel); padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; margin-bottom: 10px; }
        .btn-action { background: var(--primary); color: black; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header"><button class="btn-back" onclick="window.location.href='main.html'"><i class="fas fa-arrow-left"></i></button><h2 style="margin:0">Game Review</h2></div>
    <div id="board"></div>
    <div class="controls">
        <button class="btn-nav" onclick="first()"><i class="fas fa-angle-double-left"></i></button>
        <button class="btn-nav" onclick="prev()"><i class="fas fa-angle-left"></i></button>
        <button class="btn-nav" onclick="next()"><i class="fas fa-angle-right"></i></button>
        <button class="btn-nav" onclick="last()"><i class="fas fa-angle-double-right"></i></button>
    </div>
    <div class="info-box"><div id="status">Loading...</div><div id="bestMove" style="color:var(--primary);margin-top:5px"></div></div>
    <div class="info-box" style="display:flex;justify-content:space-between;align-items:center;"><span>PGN Data</span><button class="btn-action" onclick="copyPGN()">Copy PGN</button></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const gameId = new URLSearchParams(window.location.search).get('id');
        let game = new Chess(), board, history = [], currentStep = -1, pgnString = "";

        // BLOB STOCKFISH FIX
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');`], {type: 'application/javascript'});
        const stockfish = new Worker(URL.createObjectURL(blob));
        stockfish.onmessage = (e) => { if(e.data.startsWith('bestmove')) document.getElementById('bestMove').innerText = "Best: " + e.data.split(' ')[1]; };

        function initBoard() {
            // Force width for mobile
            $('#board').css('width', Math.min(window.innerWidth - 40, 400) + 'px');
            board = Chessboard('board', { position: 'start', pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
            loadGame();
        }

        async function loadGame() {
            if(!gameId) return;
            const d = await getDoc(doc(db, "history", gameId));
            if (d.exists() && d.data().pgn) {
                pgnString = d.data().pgn;
                game.load_pgn(pgnString);
                history = game.history({ verbose: true });
                game.reset(); board.position('start');
                updateBoard();
            } else { document.getElementById('status').innerText = "No moves found."; }
        }

        function updateBoard() {
            board.position(game.fen());
            document.getElementById('status').innerText = game.turn() === 'w' ? "White to move" : "Black to move";
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go depth 10');
        }

        window.next = () => { if (currentStep < history.length - 1) { currentStep++; game.move(history[currentStep]); updateBoard(); } };
        window.prev = () => { if (currentStep >= 0) { game.undo(); currentStep--; updateBoard(); } };
        window.first = () => { game.reset(); currentStep = -1; updateBoard(); };
        window.last = () => { while(currentStep < history.length - 1) { currentStep++; game.move(history[currentStep]); } updateBoard(); };
        window.copyPGN = () => { navigator.clipboard.writeText(pgnString).then(() => alert("Copied!")); };

        $(document).ready(initBoard);
    </script>
</body>
</html>
