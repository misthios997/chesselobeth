<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHESSELOBETH - Crazyhouse</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        html, body { overflow: hidden; position: fixed; width: 100%; height: 100%; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        .game-container { width: 95%; max-width: 400px; }
        
        .player-info { background: #262421; padding: 10px; display: flex; align-items: center; gap: 10px; border-radius: 4px; }
        .timer { margin-left: auto; font-family: monospace; font-size: 1.4rem; font-weight: bold; background: #312e2b; padding: 5px 10px; border-radius: 4px; border: 1px solid #444; min-width: 70px; text-align: center; }
        .timer.active { background: #fff; color: #000; }
        
        .pocket { background: #262421; height: 50px; display: flex; align-items: center; padding: 0 10px; gap: 5px; margin: 5px 0; border-radius: 4px; border: 1px dashed #444; overflow-x: auto; }
        .pocket img { width: 35px; height: 35px; cursor: pointer; transition: 0.1s; border-radius: 4px; }
        .pocket img.selected { background: rgba(255, 215, 0, 0.4); border: 2px solid #ffd700; box-shadow: 0 0 10px #ffd700; }
        
        #myBoard { width: 100%; box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
        .white-1e1d7 { background-color: #ebecd0 !important; }
        .black-3c85d { background-color: #779556 !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal { background: #2d2d2d; padding: 30px; border-radius: 15px; text-align: center; border: 2px solid #ffd700; width: 280px; }
        .btn-lobby { background: #81b64c; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; }
        .btn-resign { margin-top: 15px; background: none; border: 1px solid #444; color: #aaa; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="player-info">
            <span id="oppName">Opponent</span>
            <div class="timer" id="oppTimer">00:00</div>
        </div>

        <div class="pocket" id="oppPocket"></div>

        <div id="myBoard"></div>

        <div class="pocket" id="myPocket"></div>

        <div class="player-info">
            <span id="myName">Me</span>
            <div class="timer" id="myTimer">00:00</div>
        </div>

        <center><button class="btn-resign" onclick="window.resign()">RESIGN</button></center>
    </div>

    <div class="modal-overlay" id="gameOverModal">
        <div class="modal">
            <h1 id="winStatus">YOU WIN!</h1>
            <p id="winReason">By Resignation</p>
            <button class="btn-lobby" onclick="location.href='main.html'">BACK TO LOBBY</button>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('id');
    const mySide = params.get('side');

    let board, game = new Chess(), isGameOver = false;
    let timers = { w: 0, b: 0 }, timerInterval;
    let pockets = { w: [], b: [] };
    let selectedDropPiece = null;

    const pieceImg = (p) => `https://chessboardjs.com/img/chesspieces/wikipedia/${p}.png`;

    onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        const snap = await getDoc(doc(db, "rooms", roomId));
        const data = snap.data();
        
        timers = data.timers || { w: data.timer * 60, b: data.timer * 60 };
        pockets = data.pockets || { w: [], b: [] };

        document.getElementById('myName').innerText = mySide === 'white' ? data.player1.name : data.player2.name;
        document.getElementById('oppName').innerText = mySide === 'white' ? data.player2.name : data.player1.name;

        board = Chessboard('myBoard', {
            draggable: true,
            orientation: mySide,
            position: data.fen || 'start',
            pieceTheme: pieceImg('{piece}'),
            onDragStart: (src, piece) => {
                if (isGameOver) return false;
                if ((game.turn() === 'w' && mySide === 'black') || (game.turn() === 'b' && mySide === 'white')) return false;
                if ((mySide === 'white' && piece.search(/^b/) !== -1) || (mySide === 'black' && piece.search(/^w/) !== -1)) return false;
                selectedDropPiece = null;
                $('.pocket img').removeClass('selected');
            },
            onDrop: async (source, target) => {
                const move = game.move({ from: source, to: target, promotion: 'q' });
                if (move === null) return 'snapback';
                
                if (move.captured) {
                    const colorTurn = move.color;
                    const pieceShort = move.captured.toUpperCase();
                    pockets[colorTurn].push(colorTurn + pieceShort);
                }
                syncMove();
            }
        });

        // FIX: CLICK TO DROP + INSTANT RENDER
        $('#myBoard').on('click', '.square-55d63', async function() {
            if (!selectedDropPiece || isGameOver) return;
            const turn = game.turn();
            if (turn !== mySide.charAt(0)) return;

            const square = $(this).data('square');
            if (game.get(square)) return; // Harus kotak kosong

            const pieceChar = selectedDropPiece.charAt(1).toLowerCase();
            const colorChar = selectedDropPiece.charAt(0);
            
            // Taruh bidak di mesin game
            game.put({ type: pieceChar, color: colorChar }, square);
            
            // Paksa ganti giliran
            let fenArr = game.fen().split(' ');
            fenArr[1] = (fenArr[1] === 'w') ? 'b' : 'w';
            game.load(fenArr.join(' '));

            // Hapus dari pocket
            const idx = pockets[mySide.charAt(0)].indexOf(selectedDropPiece);
            if (idx > -1) pockets[mySide.charAt(0)].splice(idx, 1);

            // Update Tampilan Papan Seketika
            board.position(game.fen());

            selectedDropPiece = null;
            $('.pocket img').removeClass('selected');
            syncMove();
        });

        startTimer();

        onSnapshot(doc(db, "rooms", roomId), (s) => {
            const d = s.data();
            if (!d) return;
            if (d.fen !== game.fen()) {
                game.load(d.fen);
                board.position(d.fen);
            }
            timers = d.timers || timers;
            pockets = d.pockets || pockets;
            updateUI();
            if (d.status !== "playing" && d.status !== "waiting") showGameOver(d);
        });
    });

    async function syncMove() {
        await updateDoc(doc(db, "rooms", roomId), { 
            fen: game.fen(), 
            timers: timers,
            pockets: pockets 
        });
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (isGameOver) return;
            const turn = game.turn();
            if (timers[turn] > 0) {
                timers[turn]--;
                updateUI();
            } else {
                checkTimeout(turn);
            }
        }, 1000);
    }

    function updateUI() {
        const format = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        
        if (mySide === 'white') {
            document.getElementById('myTimer').innerText = format(timers.w);
            document.getElementById('oppTimer').innerText = format(timers.b);
            document.getElementById('myTimer').className = game.turn() === 'w' ? 'timer active' : 'timer';
            document.getElementById('oppTimer').className = game.turn() === 'b' ? 'timer active' : 'timer';
        } else {
            document.getElementById('myTimer').innerText = format(timers.b);
            document.getElementById('oppTimer').innerText = format(timers.w);
            document.getElementById('myTimer').className = game.turn() === 'b' ? 'timer active' : 'timer';
            document.getElementById('oppTimer').className = game.turn() === 'w' ? 'timer active' : 'timer';
        }

        const renderPocket = (side, elId) => {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            pockets[side].forEach((p, i) => {
                const img = document.createElement('img');
                img.src = pieceImg(p);
                if (side === mySide.charAt(0)) {
                    img.onclick = (e) => {
                        e.stopPropagation(); // Biar gak trigger click board
                        if (game.turn() !== mySide.charAt(0)) return;
                        $('.pocket img').removeClass('selected');
                        img.classList.add('selected');
                        selectedDropPiece = p;
                    };
                }
                el.appendChild(img);
            });
        };

        if (mySide === 'white') {
            renderPocket('w', 'myPocket');
            renderPocket('b', 'oppPocket');
        } else {
            renderPocket('b', 'myPocket');
            renderPocket('w', 'oppPocket');
        }
    }

    async function checkTimeout(turn) {
        if (isGameOver) return;
        const winner = turn === 'w' ? 'black' : 'white';
        await updateDoc(doc(db, "rooms", roomId), { status: "timeout", winnerSide: winner });
    }

    function showGameOver(d) {
        isGameOver = true;
        clearInterval(timerInterval);
        document.getElementById('gameOverModal').style.display = 'flex';
        const win = d.winnerSide === mySide;
        document.getElementById('winStatus').innerText = win ? "YOU WIN!" : "YOU LOST";
        document.getElementById('winStatus').style.color = win ? "#81b64c" : "#ff4d4d";
        document.getElementById('winReason').innerText = `By ${d.status}`;
    }

    window.resign = async () => {
        if(confirm("Resign?")) {
            await updateDoc(doc(db, "rooms", roomId), { 
                status: "resigned", 
                winnerSide: mySide === 'white' ? 'black' : 'white' 
            });
        }
    };
</script>
</body>
</html>
