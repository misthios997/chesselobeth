<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHESSELOBETH - Crazyhouse</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        html, body { overflow: hidden; position: fixed; width: 100%; height: 100%; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif; }
        .game-container { width: 95%; max-width: 400px; }
        .player-info { background: #2d2d2d; padding: 10px; display: flex; align-items: center; border-radius: 8px; margin: 5px 0; border: 1px solid #444; }
        .timer { margin-left: auto; font-family: monospace; font-size: 1.4rem; background: #1a1a1a; padding: 5px 10px; border-radius: 4px; color: #ffd700; }
        .timer.active { background: #ffd700; color: #000; }
        
        .pocket { background: #262421; height: 50px; display: flex; align-items: center; padding: 0 10px; gap: 5px; margin: 5px 0; border-radius: 8px; border: 2px dashed #444; overflow-x: auto; }
        .pocket img { width: 35px; height: 35px; cursor: pointer; border-radius: 4px; }
        .pocket img.selected { background: #81b64c; box-shadow: 0 0 10px #81b64c; border: 2px solid white; }

        #myBoard { width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .promo-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .promo-box { background: #2d2d2d; padding: 20px; border-radius: 12px; display: flex; gap: 10px; border: 2px solid #ffd700; }
        .promo-box img { width: 60px; height: 60px; cursor: pointer; background: #444; border-radius: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal { background: #2d2d2d; padding: 25px; border-radius: 15px; text-align: center; width: 280px; border: 2px solid #ffd700; }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="player-info">
            <b id="oppName">Opponent</b>
            <div class="timer" id="oppTimer">--:--</div>
        </div>
        <div class="pocket" id="oppPocket"></div>
        <div id="myBoard"></div>
        <div class="pocket" id="myPocket"></div>
        <div class="player-info">
            <b id="myName">Me</b>
            <div class="timer" id="myTimer">--:--</div>
        </div>
    </div>

    <div class="promo-overlay" id="promoModal">
        <div class="promo-box" id="promoOptions"></div>
    </div>

    <div class="modal-overlay" id="gameOverModal">
        <div class="modal">
            <h2 id="winStatus">GAME OVER</h2>
            <button onclick="location.href='main.html'" style="padding:10px 20px; background:#81b64c; color:white; border:none; border-radius:5px; width:100%;">BACK TO LOBBY</button>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('id');
    const mySide = params.get('side');

    let board, game = new Chess(), isGameOver = false, selectedDrop = null, pendingMove = null;
    let pockets = { w: [], b: [] };

    onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        const roomRef = doc(db, "rooms", roomId);
        const snap = await getDoc(roomRef);
        const data = snap.data();
        pockets = data.pockets || { w: [], b: [] };

        board = Chessboard('myBoard', {
            draggable: true,
            orientation: mySide,
            position: data.fen || 'start',
            onDragStart: (s, p) => !isGameOver && p.startsWith(mySide.charAt(0)) && game.turn() === mySide.charAt(0),
            onDrop: (source, target) => {
                const piece = game.get(source);
                if (piece && piece.type === 'p' && (target.endsWith('8') || target.endsWith('1'))) {
                    pendingMove = { from: source, to: target };
                    showPromo();
                    return 'snapback';
                }
                const move = game.move({ from: source, to: target, promotion: 'q' });
                if (!move) return 'snapback';
                if (move.captured) pockets[mySide.charAt(0)].push(mySide.charAt(0) + move.captured.toUpperCase());
                sync();
            }
        });

        $('#myBoard').on('click', '.square-55d63', function() {
            if (!selectedDrop || game.get($(this).data('square'))) return;
            const sq = $(this).data('square');
            game.put({ type: selectedDrop.charAt(1).toLowerCase(), color: selectedDrop.charAt(0) }, sq);
            
            let f = game.fen().split(' ');
            f[1] = f[1] === 'w' ? 'b' : 'w';
            game.load(f.join(' '));

            pockets[mySide.charAt(0)].splice(pockets[mySide.charAt(0)].indexOf(selectedDrop), 1);
            selectedDrop = null;
            board.position(game.fen());
            sync();
        });

        onSnapshot(roomRef, (s) => {
            const d = s.data();
            if (d.fen !== game.fen()) { game.load(d.fen); board.position(d.fen); }
            pockets = d.pockets || pockets;
            updateUI();
        });
    });

    function showPromo() {
        const pieces = ['q', 'r', 'b', 'n'];
        const container = document.getElementById('promoOptions');
        container.innerHTML = '';
        pieces.forEach(p => {
            const img = document.createElement('img');
            img.src = `https://chessboardjs.com/img/chesspieces/wikipedia/${mySide.charAt(0)}${p.toUpperCase()}.png`;
            img.onclick = () => {
                const move = game.move({ ...pendingMove, promotion: p });
                if (move && move.captured) pockets[mySide.charAt(0)].push(mySide.charAt(0) + move.captured.toUpperCase());
                sync();
                document.getElementById('promoModal').style.display = 'none';
            };
            container.appendChild(img);
        });
        document.getElementById('promoModal').style.display = 'flex';
    }

    function sync() { updateDoc(doc(db, "rooms", roomId), { fen: game.fen(), pockets: pockets }); }

    function updateUI() {
        const draw = (side, id) => {
            const el = document.getElementById(id);
            el.innerHTML = '';
            pockets[side].forEach(p => {
                const img = document.createElement('img');
                img.src = `https://chessboardjs.com/img/chesspieces/wikipedia/${p}.png`;
                if (side === mySide.charAt(0)) img.onclick = () => { $('.pocket img').removeClass('selected'); img.classList.add('selected'); selectedDrop = p; };
                el.appendChild(img);
            });
        };
        draw('w', mySide === 'white' ? 'myPocket' : 'oppPocket');
        draw('b', mySide === 'black' ? 'myPocket' : 'oppPocket');
    }
</script>
</body>
</html>
