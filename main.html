<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHESSELOBETH - Main</title>
    <style>
        body { background-color: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; }
        header { background: #2d2d2d; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .brand { font-weight: bold; color: #ffd700; font-size: 1.2rem; }
        .logout-btn { background: #ff4d4d; border: none; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .welcome { font-size: 1.5rem; margin-bottom: 20px; }
        .broadcast-box { background: linear-gradient(45deg, #b8860b, #daa520); color: black; padding: 15px; border-radius: 8px; margin-bottom: 30px; font-weight: bold; }
        
        /* Card Styles */
        .card { background: #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #ffd700; position: relative; }
        .card h3 { margin: 0 0 5px 0; }
        .card p { margin: 3px 0; color: #ccc; }
        .rank-gm { color: #00ffcc; font-weight: bold; text-shadow: 0 0 5px rgba(0,255,204,0.3); }
        
        .btn-action { background: none; border: 1px solid #777; color: #aaa; padding: 8px; margin-top: 10px; cursor: pointer; width: 100%; border-radius: 4px; font-weight: bold; }
        .btn-delete { border: 1px solid #ff4d4d; color: #ff4d4d; margin-top: 5px; display: none; } /* Hidden by default */
        .btn-delete:hover { background: #ff4d4d; color: white; }

        .detail-view { display: none; margin-top: 10px; border-top: 1px solid #555; padding-top: 10px; }

        /* Floating Button */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #ffd700; color: black; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 30px; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal { background: #2d2d2d; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal label { font-size: 0.8rem; color: #ffd700; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; background: #444; border: none; color: white; box-sizing: border-box; border-radius: 4px; }
        .btn-gold { background: #ffd700; color: black; width: 100%; padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-cancel { background: #555; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="brand">CHESSELOBETH</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </header>

    <div class="container">
        <div class="welcome" id="welcomeMsg">Welcome...</div>
        <div class="broadcast-box" id="broadcastDisplay">Broadcast: Loading...</div>
        <div id="dataFeed"></div>
    </div>

    <div class="fab" id="ownerFab" onclick="openMenu()">+</div>

    <div class="modal-overlay" id="menuModal">
        <div class="modal">
            <h2>Owner Actions</h2>
            <button class="btn-gold" onclick="openAddData()">[Add Data]</button>
            <button class="btn-gold" onclick="openBroadcast()">[Make An Broadcast]</button>
            <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="addDataModal">
        <div class="modal">
            <h2>Add Player Data</h2>
            <label>Name:</label>
            <input type="text" id="inpName" placeholder="Full Name">
            <label>Elo Rating:</label>
            <input type="number" id="inpElo" placeholder="Example: 1500">
            <label>Date:</label>
            <input type="text" id="inpDate" placeholder="Example: 12 Feb 2026">
            <label>Rank:</label>
            <select id="inpRank">
                <option value="None">None</option>
                <option value="CM">CM (Candidate Master)</option>
                <option value="FM">FM (Fide Master)</option>
                <option value="IM">IM (International Master)</option>
                <option value="GM">GM (Grand Master)</option>
            </select>
            <label>chess.com Account:</label>
            <input type="text" id="inpChessCom" placeholder="Username Account">
            
            <button class="btn-gold" onclick="submitData()">[Create]</button>
            <button class="btn-cancel" onclick="closeModals()">[Cancel]</button>
        </div>
    </div>

    <div class="modal-overlay" id="broadcastModal">
        <div class="modal">
            <h2>Make Broadcast</h2>
            <textarea id="inpBroadcast" rows="4" placeholder="Type message here..."></textarea>
            <button class="btn-gold" onclick="submitBroadcast()">[Send]</button>
            <button class="btn-cancel" onclick="closeModals()">[Cancel]</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw",
      authDomain: "chesselobeth.firebaseapp.com",
      projectId: "chesselobeth",
      storageBucket: "chesselobeth.firebasestorage.app",
      messagingSenderId: "829508204106",
      appId: "1:829508204106:web:e8952c359f63d49646d8b3",
      measurementId: "G-7C58TZQ48M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isOwner = false;

    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    window.openMenu = () => document.getElementById('menuModal').style.display = 'flex';
    window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none');
    window.openAddData = () => { closeModals(); document.getElementById('addDataModal').style.display = 'flex'; };
    window.openBroadcast = () => { closeModals(); document.getElementById('broadcastModal').style.display = 'flex'; };

    window.toggleInfo = (id) => {
        const d = document.getElementById(`detail-${id}`);
        const b = document.getElementById(`btn-${id}`);
        const isOpen = d.style.display === 'block';
        d.style.display = isOpen ? 'none' : 'block';
        b.innerText = isOpen ? '[See more Information]' : '[Back]';
    };

    // Fungsi Delete khusus Owner
    window.deleteData = async (id) => {
        if(confirm("Are you sure you want to delete this data?")) {
            await deleteDoc(doc(db, "players", id));
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            document.getElementById('welcomeMsg').innerText = `Welcome ${user.displayName}`;
            if(user.displayName === "Jovan") {
                isOwner = true;
                document.getElementById('ownerFab').style.display = 'flex';
            }
        }
    });

    // Realtime Broadcast
    onSnapshot(doc(db, "config", "broadcastMsg"), (d) => {
        if(d.exists()) document.getElementById('broadcastDisplay').innerText = `Broadcast: ${d.data().text}`;
    });

    // Realtime Data Feed
    const q = query(collection(db, "players"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snap) => {
        const feed = document.getElementById('dataFeed');
        feed.innerHTML = "";
        snap.forEach((doc) => {
            const data = doc.data();
            const id = doc.id;
            
            // Logika Nama & Rank
            const nameDisp = data.rank !== "None" ? `[${data.rank}] ${data.name}` : data.name;
            const rankClass = data.rank === 'GM' ? 'rank-gm' : '';
            
            // Tampilkan tombol delete hanya jika isOwner true
            const deleteBtnHtml = isOwner ? `<button class="btn-action btn-delete" style="display:block" onclick="deleteData('${id}')">[Delete]</button>` : '';

            feed.innerHTML += `
                <div class="card">
                    <h3 class="${rankClass}">${nameDisp}</h3>
                    <p>Elo Rating: ${data.elo}</p>
                    <p>Date: ${data.date}</p>
                    
                    <button class="btn-action" id="btn-${id}" onclick="toggleInfo('${id}')">[See more Information]</button>
                    ${deleteBtnHtml}

                    <div id="detail-${id}" class="detail-view">
                        <p><strong>Rank:</strong> ${data.rank}</p>
                        <p><strong>Chess.com:</strong> ${data.chessAccount || '-'}</p>
                        <p><strong>Full Name:</strong> ${data.name}</p>
                    </div>
                </div>`;
        });
    });

    window.submitData = async () => {
        const name = document.getElementById('inpName').value;
        const elo = document.getElementById('inpElo').value;
        const date = document.getElementById('inpDate').value; // Ambil manual dari text bar
        const rank = document.getElementById('inpRank').value;
        const acc = document.getElementById('inpChessCom').value;

        if(!name || !elo || !date) return alert("Please fill Name, Elo, and Date!");

        await addDoc(collection(db, "players"), { 
            name, 
            elo, 
            rank, 
            chessAccount: acc, 
            date, 
            timestamp: Date.now() 
        });
        
        // Reset inputs
        document.getElementById('inpName').value = "";
        document.getElementById('inpElo').value = "";
        document.getElementById('inpDate').value = "";
        document.getElementById('inpChessCom').value = "";
        
        closeModals();
    };

    window.submitBroadcast = async () => {
        const text = document.getElementById('inpBroadcast').value;
        if(!text) return;
        await setDoc(doc(db, "config", "broadcastMsg"), { text });
        document.getElementById('inpBroadcast').value = "";
        closeModals();
    };
</script>
</body>
</html>
