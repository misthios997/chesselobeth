<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHESSELOBETH - Lobby</title>
    <style>
        body { background-color: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; }
        header { background: #2d2d2d; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100; }
        .brand { font-weight: bold; color: #ffd700; font-size: 1.2rem; }
        .nav-btns { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: #333; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; border: 1px solid #444; overflow: hidden; }
        .profile-img-nav { width: 100%; height: 100%; object-fit: cover; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .welcome { font-size: 1.5rem; margin-bottom: 15px; color: #ffd700; }

        .lobby-card { background: #2d2d2d; padding: 20px; border-radius: 12px; border-left: 5px solid #81b64c; margin-bottom: 20px; }
        label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 8px; margin-top: 10px; }
        .selector-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .sel-btn { flex: 1; min-width: 80px; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .sel-btn.active { border-color: #81b64c; background: rgba(129, 182, 76, 0.2); color: #81b64c; }
        .btn-search { background: #81b64c; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 15px; }

        .broadcast-box { background: linear-gradient(45deg, #b8860b, #daa520); color: black; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .card { background: #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #ffd700; position: relative; }
        .card h3 { margin: 0 0 5px 0; color: #ffd700; }
        .card p { margin: 2px 0; font-size: 0.9rem; color: #ccc; }
        .admin-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .btn-small { padding: 5px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.8rem; }
        
        /* Chat Overlay */
        .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: none; flex-direction: column; z-index: 1100; }
        .chat-header { padding: 15px; background: #2d2d2d; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffd700; }
        .chat-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { display: flex; gap: 10px; max-width: 85%; }
        .msg-right { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #555; border: 1px solid #ffd700; }
        .msg-body { background: #333; padding: 10px; border-radius: 10px; }
        .msg-right .msg-body { background: #ffd700; color: black; }
        .msg-name { font-size: 0.7rem; font-weight: bold; margin-bottom: 2px; color: #ffd700; }
        .msg-right .msg-name { color: #555; text-align: right; }
        .chat-input-area { padding: 15px; background: #2d2d2d; display: flex; gap: 10px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: #2d2d2d; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .btn-gold { background: #ffd700; color: black; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px; box-sizing: border-box; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #ffd700; color: black; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #searchTimer { font-size: 2.5rem; font-weight: bold; margin: 20px 0; color: #ffd700; }
    </style>
</head>
<body>

    <header>
        <div class="brand">CHESSELOBETH</div>
        <div class="nav-btns">
            <button class="icon-btn" onclick="window.toggleChat(true)">üí¨</button>
            <button class="icon-btn" onclick="window.openProfileModal()" id="profileBtn">U</button>
        </div>
    </header>

    <div class="container">
        <div class="welcome" id="welcomeMsg">Welcome...</div>
        
        <div class="lobby-card">
            <label>Timer Set</label>
            <div class="selector-group">
                <button class="sel-btn" id="t3" onclick="window.setTimer(3, 't3')">3Min</button>
                <button class="sel-btn" id="t5" onclick="window.setTimer(5, 't5')">5Min</button>
                <button class="sel-btn active" id="t10" onclick="window.setTimer(10, 't10')">10Min</button>
            </div>

            <label>Variant</label>
            <div class="selector-group">
                <button class="sel-btn active" id="vStd" onclick="window.setVariant('standard', 'vStd')">Standard</button>
                <button class="sel-btn" id="vCh" onclick="window.setVariant('crazyhouse', 'vCh')">Crazyhouse</button>
                <button class="sel-btn" style="opacity:0.5" disabled>All Rook (Working)</button>
            </div>

            <button class="btn-search" onclick="window.startMatchmaking()">[ üîç PLAY ONLINE ]</button>
        </div>

        <div class="broadcast-box" id="broadcastDisplay">Broadcast: Loading...</div>
        <div id="dataFeed"></div>
    </div>

    <div class="fab" id="ownerFab" onclick="window.openOwnerMenu()">+</div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <h2 style="color:#ffd700">User Profile</h2>
            <div id="dropZone" onclick="document.getElementById('fileInp').click()" style="border: 2px dashed #555; padding: 20px; border-radius: 10px; cursor: pointer;">
                <p>Click to Upload Photo</p>
                <input type="file" id="fileInp" hidden accept="image/png, image/jpeg">
            </div>
            <button class="btn-gold" style="background:#ff4d4d; color:white; margin-top:20px" onclick="window.logout()">LOGOUT</button>
            <button class="btn-gold" style="background:#444; color:white" onclick="window.closeModals()">CLOSE</button>
        </div>
    </div>

    <div class="chat-overlay" id="chatOverlay">
        <div class="chat-header">
            <b>LIVE CHAT</b>
            <button onclick="window.toggleChat(false)" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="chat-content" id="chatBox"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type here..." onkeypress="if(event.key==='Enter')window.sendChat()">
            <button onclick="window.sendChat()" style="background:#ffd700; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">SEND</button>
        </div>
    </div>

    <div class="modal-overlay" id="ownerMenuModal">
        <div class="modal">
            <h2 style="color:#ffd700">Owner Actions</h2>
            <button class="btn-gold" onclick="window.openAddData()">[Add Data Player]</button>
            <button class="btn-gold" onclick="window.openBroadcastModal()">[Update Broadcast]</button>
            <button class="btn-gold" style="background:#ff4d4d; color:white" onclick="window.resetChat()">[Reset Chat]</button>
            <button class="btn-gold" style="background:#444; color:white" onclick="window.closeModals()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="addDataModal">
        <div class="modal">
            <h2>New Player Data</h2>
            <input type="text" id="inpName" placeholder="Full Name">
            <input type="number" id="inpElo" placeholder="Elo Rating">
            <input type="text" id="inpDate" placeholder="Date (e.g. 12 Feb 2026)">
            <select id="inpRank">
                <option value="None">Rank: None</option>
                <option value="CM">CM</option>
                <option value="FM">FM</option>
                <option value="IM">IM</option>
                <option value="GM">GM</option>
            </select>
            <input type="text" id="inpAccount" placeholder="Chess.com Account">
            <button class="btn-gold" onclick="window.submitData()">SAVE PLAYER</button>
            <button class="btn-gold" style="background:#444; color:white" onclick="window.closeModals()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="editDataModal">
        <div class="modal">
            <h2>Edit Player Data</h2>
            <input type="hidden" id="editId">
            <input type="text" id="editName" placeholder="Full Name">
            <input type="number" id="editElo" placeholder="Elo Rating">
            <input type="text" id="editDate" placeholder="Date">
            <select id="editRank">
                <option value="None">Rank: None</option>
                <option value="CM">CM</option>
                <option value="FM">FM</option>
                <option value="IM">IM</option>
                <option value="GM">GM</option>
            </select>
            <input type="text" id="editAccount" placeholder="Chess.com Account">
            <button class="btn-gold" onclick="window.saveEditData()">UPDATE PLAYER</button>
            <button class="btn-gold" style="background:#444; color:white" onclick="window.closeModals()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="broadcastModal">
        <div class="modal">
            <h2>Update Broadcast</h2>
            <textarea id="inpBroadcast" rows="3"></textarea>
            <button class="btn-gold" onclick="window.submitBroadcast()">UPDATE</button>
            <button class="btn-gold" style="background:#444; color:white" onclick="window.closeModals()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="searchModal">
        <div class="modal">
            <h2 style="margin:0; color:#ffd700;">Searching...</h2>
            <div id="searchTimer">00:00</div>
            <p id="searchStatus" style="font-size:0.8rem; color:#aaa;">Matching variant & timer</p>
            <button class="btn-gold" style="background:#ff4d4d; color:white" onclick="window.cancelSearch()">CANCEL</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, getDocs, where, deleteDoc, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUsername = "";
    let selectedTimer = 10;
    let selectedVariant = "standard";
    let searchInterval, currentRoomId, unsubRoom;

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            currentUsername = user.displayName;
            document.getElementById('welcomeMsg').innerText = `Welcome ${currentUsername}`;
            const upic = user.photoURL || `https://ui-avatars.com/api/?name=${currentUsername}`;
            document.getElementById('profileBtn').innerHTML = `<img src="${upic}" class="profile-img-nav">`;
            
            if(currentUsername === "Jovan") {
                document.getElementById('ownerFab').style.display = 'flex';
            }
            loadData();
        }
    });

    // --- DATA LOAD (Feed & Broadcast) ---
    function loadData() {
        onSnapshot(doc(db, "config", "broadcastMsg"), (d) => {
            if(d.exists()) document.getElementById('broadcastDisplay').innerText = `Broadcast: ${d.data().text}`;
        });

        onSnapshot(query(collection(db, "players"), orderBy("timestamp", "desc")), (snap) => {
            const feed = document.getElementById('dataFeed');
            feed.innerHTML = '<label>Recent Players</label>';
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const rankDisplay = data.rank && data.rank !== 'None' ? `<span style="color:#ffd700; font-weight:bold">[${data.rank}]</span> ` : '';
                
                let adminControls = '';
                if(currentUsername === "Jovan") {
                    // Menyimpan data dalam attribute data-json string untuk kemudahan edit
                    const dataStr = JSON.stringify(data).replace(/"/g, '&quot;');
                    adminControls = `
                    <div class="admin-actions">
                        <button class="btn-small" style="background:#444" onclick="window.openEdit('${docSnap.id}', '${dataStr}')">Edit</button>
                        <button class="btn-small" style="background:#ff4d4d" onclick="window.deleteData('${docSnap.id}')">Del</button>
                    </div>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${rankDisplay}${data.name}</h3>
                    <p>Elo: ${data.elo} | Date: ${data.date || '-'}</p>
                    <p style="font-size:0.8rem; color:#888">${data.chessAccount || 'No Account'}</p>
                    ${adminControls}
                `;
                feed.appendChild(card);
            });
        });
    }

    // --- CHAT SYSTEM ---
    window.toggleChat = (s) => {
        document.getElementById('chatOverlay').style.display = s ? 'flex' : 'none';
        if(s) { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
    };
    window.sendChat = async () => {
        const inp = document.getElementById('chatInput');
        if(!inp.value.trim()) return;
        await addDoc(collection(db, "chats"), { name: currentUsername, text: inp.value, photo: auth.currentUser.photoURL || "", timestamp: Date.now() });
        inp.value = "";
    };
    onSnapshot(query(collection(db, "chats"), orderBy("timestamp", "asc"), limit(100)), (snap) => {
        const box = document.getElementById('chatBox');
        box.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            const side = c.name === currentUsername ? 'msg-right' : '';
            const pic = c.photo || `https://ui-avatars.com/api/?name=${c.name}`;
            box.innerHTML += `<div class="msg ${side}"><img src="${pic}" class="msg-avatar"><div class="msg-body"><div class="msg-name">${c.name}</div><div>${c.text}</div></div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    // --- PROFILE & PHOTO ---
    window.openProfileModal = () => document.getElementById('profileModal').style.display = 'flex';
    document.getElementById('fileInp').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const sRef = ref(storage, `profiles/${auth.currentUser.uid}`);
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        await updateProfile(auth.currentUser, { photoURL: url });
        location.reload();
    };

    // --- OWNER ACTIONS (ADD, EDIT, DELETE) ---
    window.openOwnerMenu = () => document.getElementById('ownerMenuModal').style.display = 'flex';
    window.openAddData = () => { window.closeModals(); document.getElementById('addDataModal').style.display = 'flex'; };
    window.openBroadcastModal = () => { window.closeModals(); document.getElementById('broadcastModal').style.display = 'flex'; };
    window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    
    // Add Data
    window.submitData = async () => {
        const payload = {
            name: document.getElementById('inpName').value,
            elo: document.getElementById('inpElo').value,
            date: document.getElementById('inpDate').value,
            rank: document.getElementById('inpRank').value,
            chessAccount: document.getElementById('inpAccount').value,
            timestamp: Date.now()
        };
        await addDoc(collection(db, "players"), payload);
        window.closeModals();
    };

    // Delete Data
    window.deleteData = async (id) => {
        if(confirm("Delete this player data?")) await deleteDoc(doc(db, "players", id));
    };

    // Edit Data (New Feature)
    window.openEdit = (id, dataStr) => {
        const data = JSON.parse(dataStr);
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = data.name;
        document.getElementById('editElo').value = data.elo;
        document.getElementById('editDate').value = data.date || "";
        document.getElementById('editRank').value = data.rank || "None";
        document.getElementById('editAccount').value = data.chessAccount || "";
        
        window.closeModals();
        document.getElementById('editDataModal').style.display = 'flex';
    };

    window.saveEditData = async () => {
        const id = document.getElementById('editId').value;
        const payload = {
            name: document.getElementById('editName').value,
            elo: document.getElementById('editElo').value,
            date: document.getElementById('editDate').value,
            rank: document.getElementById('editRank').value,
            chessAccount: document.getElementById('editAccount').value
        };
        await updateDoc(doc(db, "players", id), payload);
        window.closeModals();
    };

    window.submitBroadcast = async () => {
        await setDoc(doc(db, "config", "broadcastMsg"), { text: document.getElementById('inpBroadcast').value });
        window.closeModals();
    };
    window.resetChat = async () => {
        if(confirm("Reset all chat?")) {
            const q = await getDocs(collection(db, "chats"));
            q.forEach(async (d) => await deleteDoc(doc(db, "chats", d.id)));
        }
    };

    // --- MATCHMAKING ---
    window.setTimer = (v, id) => { selectedTimer = v; document.querySelectorAll('[id^="t"]').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); };
    window.setVariant = (v, id) => { selectedVariant = v; document.querySelectorAll('[id^="v"]').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); };

    window.startMatchmaking = async () => {
        document.getElementById('searchModal').style.display = 'flex';
        let sec = 0;
        searchInterval = setInterval(() => { sec++; document.getElementById('searchTimer').innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`; }, 1000);

        const q = query(collection(db, "rooms"), where("status", "==", "waiting"), where("timer", "==", selectedTimer), where("variant", "==", selectedVariant));
        const snap = await getDocs(q);
        if (!snap.empty) {
            currentRoomId = snap.docs[0].id;
            await updateDoc(doc(db, "rooms", currentRoomId), { player2: { name: currentUsername, photo: auth.currentUser.photoURL || "" }, status: "playing" });
            goToGame(selectedVariant, currentRoomId, 'black');
        } else {
            const newRoom = await addDoc(collection(db, "rooms"), { 
                player1: { name: currentUsername, photo: auth.currentUser.photoURL || "" }, 
                status: "waiting", 
                timer: selectedTimer, 
                variant: selectedVariant, 
                fen: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", 
                pockets: { w: "", b: "" }, // Crazyhouse Pockets
                createdAt: Date.now() 
            });
            currentRoomId = newRoom.id;
            unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (s) => { if (s.data()?.status === "playing") goToGame(selectedVariant, currentRoomId, 'white'); });
        }
    };
    function goToGame(v, id, s) { clearInterval(searchInterval); if(unsubRoom) unsubRoom(); window.location.href = `${v === "crazyhouse" ? "crazyhouse.html" : "game.html"}?id=${id}&side=${s}`; }
    window.cancelSearch = async () => { clearInterval(searchInterval); if (currentRoomId) await deleteDoc(doc(db, "rooms", currentRoomId)); document.getElementById('searchModal').style.display = 'none'; };
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
</script>
</body>
</html>
