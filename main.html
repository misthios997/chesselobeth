<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHESSELOBETH - Main</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #ffffff; --accent: #81b64c; --red: #ff4d4d; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        header { background: #2d2d2d; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 15px rgba(0,0,0,0.6); position: sticky; top: 0; z-index: 1000; }
        .brand { font-weight: 900; color: var(--primary); font-size: 1.4rem; letter-spacing: 1px; }
        .nav-right { display: flex; gap: 15px; align-items: center; }
        .dots-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; position: relative; }
        .red-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background: var(--red); border-radius: 50%; display: none; border: 2px solid #2d2d2d; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 45px; background: #333; min-width: 220px; border-radius: 12px; z-index: 1001; border: 1px solid #444; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .dropdown-menu a { color: white; padding: 14px 20px; text-decoration: none; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #444; }
        .dropdown-menu a:hover { background: var(--primary); color: black; }
        .profile-trigger { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; }
        .broadcast-container { margin: 15px 20px; }
        #broadcastBox { background: linear-gradient(135deg, #b8860b, #daa520); color: black; padding: 15px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .container { max-width: 600px; margin: 0 auto; padding: 10px 20px; }
        .welcome-text { font-size: 1.6rem; font-weight: bold; margin-bottom: 20px; color: var(--primary); }
        .play-card { background: var(--card); border-radius: 18px; padding: 25px; border-left: 6px solid var(--accent); margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .sel-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .btn-opt { background: #3d3d3d; border: 1px solid #4d4d4d; color: white; padding: 14px 5px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-opt.active { background: rgba(129, 182, 76, 0.2); border-color: var(--accent); color: var(--accent); }
        .btn-main { background: var(--accent); color: white; width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: 900; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .data-card { background: #262626; padding: 15px; margin-bottom: 10px; border-radius: 12px; border-left: 5px solid var(--primary); position: relative; }
        .list-item { background: #262626; padding: 12px; margin-bottom: 10px; border-radius: 10px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; border: 1px solid #333; }
        .list-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid #555; }
        .list-actions { display: flex; gap: 8px; margin-top: 8px; width: 100%; }
        .btn-mini { padding: 8px 12px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.8rem; font-weight: bold; flex: 1; transition: 0.2s; }
        .btn-blue { background: #3498db; } .btn-green { background: var(--accent); } .btn-red { background: var(--red); } .btn-gray { background: #555; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 4000; backdrop-filter: blur(5px); }
        .modal { background: #2d2d2d; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #chatOverlay, #pChatOverlay { position: fixed; bottom: 0; right: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; z-index: 3000; }
        .chat-header { background: #2d2d2d; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; font-weight: bold; }
        #chatBox, #pChatBox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-wrap { display: flex; gap: 10px; align-items: flex-start; } .msg-self { flex-direction: row-reverse; }
        .msg-ava { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .msg-content { display: flex; flex-direction: column; max-width: 75%; }
        .msg-name { font-size: 0.7rem; color: var(--primary); font-weight: bold; margin-bottom: 2px; }
        .msg-bubble { background: #333; padding: 10px; border-radius: 12px; font-size: 0.9rem; color: white; line-height: 1.4; } .msg-self .msg-bubble { background: var(--primary); color: black; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: white; box-sizing: border-box; outline: none; }
        .btn-gold { background: var(--primary); color: black; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: 900; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: black; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 1.8rem; z-index: 900; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; }
        #bannedOverlay { position: fixed; inset: 0; background: #000; color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; text-align: center; padding: 20px; }
        #updateNotify { text-align: center; font-size: 0.85rem; font-weight: bold; margin: 15px 0 0 0; color: #aaa; }
        .history-item { border-bottom: 1px solid #444; padding: 8px 0; font-size: 0.85rem; color: #ccc; }
        .ava-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .ava-pick { width: 100%; aspect-ratio: 1/1; border-radius: 10px; border: 3px solid transparent; cursor: pointer; object-fit: cover; }
    </style>
</head>
<body>

    <div id="bannedOverlay">
        <i class="fas fa-user-slash" style="font-size: 3rem; color: #ff4d4d; margin-bottom: 20px;"></i>
        <h1 style="color: #ff4d4d;">You are Banned from Owner</h1>
        <p id="banDetail" style="margin: 10px 0; color: #ccc;"></p>
        <button class="btn-gold" style="width: auto; padding: 10px 30px;" onclick="location.reload()">REFRESH</button>
    </div>

    <header>
        <div class="brand">CHESSELOBETH</div>
        <div class="nav-right">
            <button class="dots-btn" onclick="toggleChat(true)"><i class="far fa-comment-dots"></i></button>
            <div class="menu-container">
                <button class="dots-btn" onclick="toggleDropdown()">
                    <i class="fas fa-ellipsis-v"></i>
                    <div id="inboxDot" class="red-dot"></div>
                </button>
                <div class="dropdown-menu" id="mainMenu">
                    <a href="#" onclick="switchSection('online')"><i class="fas fa-globe"></i> Play Online</a>
                    <a href="#" onclick="switchSection('bot')"><i class="fas fa-robot"></i> Play Bot</a>
                    <a href="#" onclick="openInbox()"><i class="fas fa-envelope"></i> Inbox <span id="inboxCount"></span></a>
                    <a href="#" onclick="openAddFriend()"><i class="fas fa-search"></i> Add Friend</a>
                    <a href="#" onclick="openFriendList()"><i class="fas fa-users"></i> Friend List</a>
                    <a href="#" onclick="switchSection('elo')"><i class="fas fa-list-ol"></i> Data Player</a>
                    <a href="#" onclick="openUpdateModal()"><i class="fas fa-sync-alt"></i> Update Status</a>
                    <a href="#" id="ownerMenuBtn" style="display:none; color:var(--primary)" onclick="openOwnerTools()"><i class="fas fa-shield-alt"></i> Owner Action</a>
                    <a href="#" onclick="logout()" style="color:#ff4d4d"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
            <img id="myAvatar" class="profile-trigger" src="" onclick="openAvatarModal()">
        </div>
    </header>

    <div id="updateNotify">Update: Not Available</div>
    <div class="broadcast-container"><div id="broadcastBox"><i class="fas fa-bullhorn"></i> <span id="bcText" style="margin-left:8px;">Loading...</span></div></div>

    <div class="container">
        <div class="welcome-text" id="welcomeMsg">Welcome...</div>

        <div id="sec-online" class="section-view">
            <div class="play-card">
                <label class="label-group">Timer Set</label>
                <div class="sel-grid" id="timerGrid">
                    <button class="btn-opt" onclick="setTimer(3, this)">3Min</button>
                    <button class="btn-opt" onclick="setTimer(5, this)">5Min</button>
                    <button class="btn-opt active" onclick="setTimer(10, this)">10Min</button>
                </div>
                <label class="label-group">Variant</label>
                <div class="sel-grid" id="variantGrid" style="grid-template-columns: 1fr 1fr; margin-top:10px;">
                    <button class="btn-opt active" onclick="setVariant('standard', this)">Standard</button>
                    <button class="btn-opt" onclick="setVariant('crazyhouse', this)">Crazyhouse</button>
                </div>
                <button class="btn-main" style="margin-top:15px;" onclick="startMatchmaking()">[ <i class="fas fa-search"></i> PLAY ONLINE ]</button>
            </div>
        </div>

        <div id="sec-bot" class="section-view" style="display:none">
             <div class="play-card" style="border-left-color: var(--primary)">
                <h2>Vs Stockfish</h2>
                <div class="sel-grid" id="botGrid" style="grid-template-columns: 1fr 1fr">
                    <button class="btn-opt active" onclick="setBotLvl(1, this)">Lvl 1</button>
                    <button class="btn-opt" onclick="setBotLvl(10, this)">Lvl 10</button>
                </div>
                <button class="btn-main" onclick="startBot()">START BOT â–¶</button>
             </div>
        </div>

        <div id="sec-elo" class="section-view" style="display:none">
            <h2 style="color:var(--primary)">Recent Players</h2>
            <div id="dataFeed"></div>
        </div>
    </div>

    <button class="fab" id="ownerFab" onclick="openAddModal()"><i class="fas fa-plus"></i></button>

    <div class="modal-overlay" id="inboxModal">
        <div class="modal">
            <h2 style="color:var(--primary)">Inbox</h2>
            <div id="inboxContent" style="min-height: 50px;"></div>
            <button class="btn-gold" style="background:#444; color:white" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div class="modal-overlay" id="addFriendModal">
        <div class="modal">
            <h2 style="color:var(--primary)">Add Friend</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="friendSearchIn" placeholder="Search Name..." style="margin:0;">
                <button class="btn-gold" style="width:auto; margin:0; padding:10px;" onclick="searchFriend()">Search</button>
            </div>
            <div id="friendSearchResults" style="margin-top:15px; font-weight:bold; color:#aaa;">Result: None</div>
            <hr style="border:0.5px solid #444; margin:15px 0;">
            <h3>Recommendation</h3>
            <div id="friendRecsContent"></div>
            <button class="btn-gold" style="background:#444; color:white" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div class="modal-overlay" id="friendListModal">
        <div class="modal">
            <h2 style="color:var(--primary)">Friend List</h2>
            <div id="friendListContent"></div>
            <button class="btn-gold" style="background:#444; color:white" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div class="modal-overlay" id="infoModal">
        <div class="modal">
            <button class="btn-mini" style="background:#444; width:auto;" onclick="document.getElementById('infoModal').style.display='none'">Back</button>
            <div style="text-align:center; margin-top:15px;">
                <img id="infoImg" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary); object-fit:cover;">
                <h2 id="infoName" style="margin:5px 0;"></h2>
                <span id="infoTitle" style="color:var(--primary); font-weight:bold;"></span>
            </div>
            <h3 style="margin-top:20px; border-bottom:1px solid #444;">History</h3>
            <div id="infoHistory" style="max-height:150px; overflow-y:auto;"></div>
            <div id="infoActions" style="margin-top:20px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="challengeModal">
        <div class="modal">
            <h3>Challenge <span id="chalTarget" style="color:var(--primary)"></span></h3>
            <label>Timer</label>
            <select id="chalTimer"><option value="3">3 Min</option><option value="5">5 Min</option><option value="10">10 Min</option></select>
            <label>Play As</label>
            <select id="chalSide"><option value="white">White</option><option value="black">Black</option></select>
            <label>Variant</label>
            <select id="chalVariant"><option value="standard">Standard</option><option value="crazyhouse">Crazyhouse</option></select>
            <button class="btn-gold" onclick="sendChallenge()">SEND CHALLENGE</button>
            <button class="btn-gold" style="background:#444" onclick="closeModals()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="searchOverlay">
        <div class="modal" style="text-align: center;">
            <h2 id="searchTitle">Searching...</h2>
            <div id="searchTimer" style="font-size:3rem; color:var(--primary); font-weight:900; margin:20px 0;">00:00</div>
            <button class="btn-gold" style="background:#ff4d4d; color:white" onclick="cancelSearch()">CANCEL</button>
        </div>
    </div>

    <div class="modal-overlay" id="updateStatusModal"><div class="modal" style="text-align:center"><h2>Update Status</h2><div id="updateContent"></div><button class="btn-gold" style="background:#444" onclick="closeModals()">CLOSE</button></div></div>
    <div class="modal-overlay" id="avatarModal"><div class="modal"><h2 style="text-align:center">Choose Avatar</h2><div class="ava-options"><img src="https://i.ibb.co.com/Fb6FJQ9g/54b19ada-d53e-4ee9-8882-9dfed1bf1396.jpg" class="ava-pick" onclick="selectAva(this.src)"><img src="https://i.ibb.co.com/jZhYZky2/68f9ebed-9db3-458f-aa15-b5b6dfc8566c.jpg" class="ava-pick" onclick="selectAva(this.src)"></div><button class="btn-gold" style="background:#444" onclick="closeModals()">CANCEL</button></div></div>

    <div class="modal-overlay" id="ownerToolsModal">
        <div class="modal">
            <h2>Owner Actions</h2>
            <textarea id="bcInput" rows="2" placeholder="Update broadcast..."></textarea>
            <button class="btn-gold" onclick="updateBC()">UPDATE BC</button>
            <input type="text" id="notifAllIn" placeholder="Give Notification to All">
            <button class="btn-gold" onclick="sendGlobalNotif()">SEND</button>
            <hr style="border-color:#444">
            <input type="text" id="accName" placeholder="Add Access (Name)">
            <button class="btn-gold" onclick="addAccess()">ACCESS</button>
            <input type="text" id="titleName" placeholder="Title Name">
            <select id="titlePick"><option value="GM">GM</option><option value="IM">IM</option><option value="CM">CM</option><option value="FM">FM</option></select>
            <button class="btn-gold" onclick="addTitle()">GIVE TITLE</button>
            <button class="btn-gold" onclick="pushUpdate()">[ SET UPDATE STATUS ]</button>
            <hr style="border-color:#444">
            <input type="text" id="banName" placeholder="Ban Name">
            <div style="display:flex;gap:5px"><input id="banSec" placeholder="S"><input id="banMin" placeholder="M"><input id="banDay" placeholder="D"></div>
            <button class="btn-gold" style="background:var(--red)" onclick="banUser()">BAN!</button>
            <input type="text" id="unbanName" placeholder="Unban Name">
            <button class="btn-gold" style="background:var(--accent)" onclick="unbanUser()">UNBAN</button>
            <button class="btn-gold" style="background:#444" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div id="chatOverlay">
        <div class="chat-header"><b>LIVE CHAT</b><button onclick="toggleChat(false)" style="background:none; border:none; color:white; font-size:1.5rem">&times;</button></div>
        <div id="chatBox"></div>
        <div style="padding:15px; display:flex; gap:10px; background:#2d2d2d;">
            <input type="text" id="chatIn" style="flex:1; margin:0;" placeholder="Type..." onkeypress="if(event.key==='Enter')sendChat()">
            <button onclick="sendChat()" style="background:var(--primary); border:none; padding:10px 20px; border-radius:8px; font-weight:bold;">SEND</button>
        </div>
    </div>

    <div id="pChatOverlay" style="display:none;">
        <div class="chat-header">
            <button onclick="document.getElementById('pChatOverlay').style.display='none'" style="background:none; border:none; color:white"><i class="fas fa-arrow-left"></i></button>
            <b id="pChatTarget">Chat</b>
            <div></div>
        </div>
        <div id="pChatBox"></div>
        <div style="padding:15px; display:flex; gap:10px; background:#2d2d2d;">
            <input type="text" id="pChatIn" style="flex:1; margin:0;" placeholder="Type..." onkeypress="if(event.key==='Enter')sendPrivateChat()">
            <button onclick="sendPrivateChat()" style="background:var(--primary); border:none; padding:10px 20px; border-radius:8px; font-weight:bold;">SEND</button>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h2>Add Player Data</h2>
            <input type="text" id="inName" placeholder="Full Name">
            <input type="number" id="inElo" placeholder="Elo Rating">
            <input type="text" id="inDate" placeholder="Date">
            <select id="inRank"><option value="None">No Rank</option><option value="GM">GM</option></select>
            <button class="btn-gold" onclick="submitData()">SAVE</button>
            <button class="btn-gold" style="background:#444" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, limit, where, getDocs, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user, curName, myTitle = "", timerVal = 10, variant = "standard", botLvl = 1, sInterval, roomId, unsubRoom, unsubPChat;
        let serverVersion = 0;

        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        window.toggleDropdown = () => { const m = document.getElementById('mainMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
        window.switchSection = (s) => { document.querySelectorAll('.section-view').forEach(v => v.style.display = 'none'); document.getElementById('sec-'+s).style.display = 'block'; window.toggleDropdown(); };
        window.openInbox = async () => { 
            document.getElementById('inboxModal').style.display = 'flex'; window.toggleDropdown();
            document.getElementById('inboxDot').style.display = 'none';
            const s = await getDocs(query(collection(db, "inbox"), where("to", "==", curName), where("read", "==", false)));
            s.forEach(d => updateDoc(doc(db, "inbox", d.id), { read: true }));
        };
        window.delInbox = async(id) => await deleteDoc(doc(db, "inbox", id));
        window.openAddFriend = () => { document.getElementById('addFriendModal').style.display='flex'; loadRecs(); window.toggleDropdown(); };
        window.openFriendList = () => { document.getElementById('friendListModal').style.display='flex'; loadFriendList(); window.toggleDropdown(); };
        window.openOwnerTools = () => { document.getElementById('ownerToolsModal').style.display = 'flex'; window.toggleDropdown(); };
        window.openAddModal = () => document.getElementById('addModal').style.display = 'flex';
        window.openAvatarModal = () => document.getElementById('avatarModal').style.display = 'flex';
        window.toggleChat = (s) => document.getElementById('chatOverlay').style.display = s ? 'flex' : 'none';
        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
        
        window.setTimer = (v, b) => { timerVal = v; document.querySelectorAll('#timerGrid .btn-opt').forEach(x => x.classList.remove('active')); b.classList.add('active'); };
        window.setVariant = (v, b) => { variant = v; document.querySelectorAll('#variantGrid .btn-opt').forEach(x => x.classList.remove('active')); b.classList.add('active'); };
        window.setBotLvl = (v, b) => { botLvl = v; document.querySelectorAll('#botGrid .btn-opt').forEach(x => x.classList.remove('active')); b.classList.add('active'); };
        window.startBot = () => window.location.href = `botgame.html?lvl=${botLvl}`;

        onAuthStateChanged(auth, async (u) => {
            if(!u) window.location.href = "index.html";
            else {
                user = u; curName = u.displayName;
                checkBanStatus(curName);
                await setDoc(doc(db, "users", curName), { name: curName, photo: u.photoURL || "https://i.ibb.co.com/8LpY5v7/avatar1.jpg" }, { merge: true });
                const tDoc = await getDoc(doc(db, "titles", curName));
                if(tDoc.exists()) { myTitle = tDoc.data().title; await updateDoc(doc(db, "users", curName), { title: myTitle }); }
                document.getElementById('welcomeMsg').innerText = `Welcome, ${myTitle ? '['+myTitle+'] ' : ''}${curName}`;
                document.getElementById('myAvatar').src = u.photoURL || "https://i.ibb.co.com/8LpY5v7/avatar1.jpg";
                const aDoc = await getDoc(doc(db, "access", curName));
                if(curName === "Jovan" || aDoc.exists()) { document.getElementById('ownerFab').style.display = 'flex'; document.getElementById('ownerMenuBtn').style.display = 'block'; }
                loadData(); listenInbox();
            }
        });

        function listenInbox() {
            onSnapshot(query(collection(db, "inbox"), where("to", "==", curName)), (s) => {
                const list = document.getElementById('inboxContent'); list.innerHTML = "";
                let hasUnread = false;
                s.forEach(d => {
                    const m = d.data();
                    if(!m.read) hasUnread = true;
                    let content = "";
                    if(m.type === 'system') content = `<div style="color:var(--primary); font-weight:bold; margin-bottom:5px">System:</div> ${m.text}`;
                    else if(m.type === 'friend_request') {
                        content = `<div><b>${m.from}</b> wants to be friends.</div>
                        <div class="list-actions">
                            <button class="btn-mini btn-green" onclick="acceptFriend('${d.id}', '${m.from}')">Accept</button>
                            <button class="btn-mini btn-red" onclick="delInbox('${d.id}')">Decline</button>
                        </div>`;
                    }
                    else if(m.type === 'challenge') {
                        content = `<div><b>${m.from}</b> Invite you to Play (${m.variant}) as (${m.side})</div>
                        <div class="list-actions">
                            <button class="btn-mini btn-green" onclick="acceptChal('${d.id}','${m.from}','${m.variant}','${m.side}','${m.timer}')">Accept</button>
                            <button class="btn-mini btn-red" onclick="delInbox('${d.id}')">Decline</button>
                        </div>`;
                    }
                    list.innerHTML += `<div class="list-item" style="display:block">${content}</div>`;
                });
                document.getElementById('inboxDot').style.display = hasUnread ? 'block' : 'none';
                document.getElementById('inboxCount').innerText = hasUnread ? '(!)' : '';
            });
        }

        window.addFriend = async (name) => {
            await addDoc(collection(db, "inbox"), {
                to: name, from: curName, type: 'friend_request', 
                text: `${curName} wants to be friends.`, read: false, timestamp: Date.now()
            });
            alert("Friend Request Sent!");
        };

        window.acceptFriend = async (id, requester) => {
            await addDoc(collection(db, "friends"), { user: curName, friend: requester });
            await addDoc(collection(db, "friends"), { user: requester, friend: curName });
            await deleteDoc(doc(db, "inbox", id));
            alert("Friend Added!");
        };

        window.searchFriend = async () => {
            const val = document.getElementById('friendSearchIn').value;
            const res = document.getElementById('friendSearchResults');
            if(!val) { res.innerHTML = "Result: None"; return; }
            
            let foundUsers = [];
            const q = query(collection(db, "users"), where("name", ">=", val), where("name", "<=", val + '\uf8ff'));
            const s = await getDocs(q);
            s.forEach(d => foundUsers.push(d.data()));

            const dDoc = await getDoc(doc(db, "users", val));
            if(dDoc.exists() && !foundUsers.some(u => u.name === dDoc.data().name)) foundUsers.push(dDoc.data());

            if(foundUsers.length === 0) res.innerHTML = "Result: None";
            else {
                res.innerHTML = "Result:";
                foundUsers.forEach(u => {
                    if(u.name !== curName) {
                        res.innerHTML += `
                        <div class="list-item">
                            <img src="${u.photo}">
                            <div class="list-content"><b>${u.name}</b></div>
                            <div class="list-actions">
                                <button class="btn-mini btn-blue" onclick="addFriend('${u.name}')">Add</button>
                                <button class="btn-mini btn-gray" onclick="seeInfo('${u.name}')">Info</button>
                            </div>
                        </div>`;
                    }
                });
            }
        };

        async function loadRecs() {
            const s = await getDocs(query(collection(db, "users"), limit(3)));
            const l = document.getElementById('friendRecsContent'); l.innerHTML = "";
            s.forEach(d => {
                if(d.data().name !== curName) l.innerHTML += `<div class="list-item"><b>${d.data().name}</b><div class="list-actions"><button class="btn-mini btn-blue" onclick="addFriend('${d.data().name}')">Add</button><button class="btn-mini btn-gray" onclick="seeInfo('${d.data().name}')">Info</button></div></div>`;
            });
        }

        async function loadFriendList() {
            const s = await getDocs(query(collection(db, "friends"), where("user", "==", curName)));
            const l = document.getElementById('friendListContent'); l.innerHTML = "";
            s.forEach(d => {
                const f = d.data().friend;
                l.innerHTML += `<div class="list-item"><b>${f}</b><div class="list-actions"><button class="btn-mini btn-green" onclick="openChal('${f}')">Challenge</button><button class="btn-mini btn-gray" onclick="seeInfo('${f}')">Info</button></div></div>`;
            });
        }

        window.seeInfo = async (name) => {
            const u = await getDoc(doc(db, "users", name));
            if(!u.exists()) return;
            const d = u.data();
            document.getElementById('infoName').innerText = d.name;
            document.getElementById('infoImg').src = d.photo;
            document.getElementById('infoTitle').innerText = d.title || "No Title";
            const h = document.getElementById('infoHistory'); h.innerHTML = "";
            const hSnap = await getDocs(query(collection(db, "history"), where("player", "==", name), limit(5)));
            hSnap.forEach(hd => {
                const hist = hd.data();
                h.innerHTML += `<div class="history-item">${hist.player} vs ${hist.opp} (${hist.res.includes(name) ? '+' : '-'})</div>`;
            });
            document.getElementById('infoActions').innerHTML = `<button class="btn-gold" style="background:#3498db" onclick="openPrivateChat('${name}')">Chat Privately</button>`;
            document.getElementById('infoModal').style.display='flex';
        };

        window.openChal = (name) => { document.getElementById('chalTarget').innerText = name; document.getElementById('challengeModal').style.display='flex'; };
        
        window.sendChallenge = async () => {
            const to = document.getElementById('chalTarget').innerText;
            const chalRef = await addDoc(collection(db, "challenges"), { from: curName, to: to, status: "pending", timestamp: Date.now() });
            await addDoc(collection(db, "inbox"), {
                to: to, from: curName, type: 'challenge', 
                timer: document.getElementById('chalTimer').value, 
                side: document.getElementById('chalSide').value, 
                variant: document.getElementById('chalVariant').value, 
                challengeId: chalRef.id, 
                timestamp: Date.now(), read: false
            });
            document.getElementById('searchTitle').innerText = "Waiting for Friend...";
            document.getElementById('searchOverlay').style.display = 'flex';
            closeModals();
            unsubRoom = onSnapshot(chalRef, (s) => {
                if(s.exists() && s.data().status === "accepted") {
                    const v = s.data().variant === 'crazyhouse' ? 'crazyhouse' : 'game';
                    window.location.href = `${v}.html?id=${s.data().roomId}&side=${document.getElementById('chalSide').value}`;
                }
            });
        };

        window.acceptChal = async (inboxId, opp, vari, oppSide, timer) => {
            const mySide = oppSide === 'white' ? 'black' : 'white';
            const newRoomId = "CHAL_" + Date.now();
            await setDoc(doc(db, "rooms", newRoomId), { player1: { name: opp }, player2: { name: curName }, status: "playing", variant: vari, timer: parseInt(timer) });
            const inboxDoc = await getDoc(doc(db, "inbox", inboxId));
            if(inboxDoc.exists()) {
                const chalId = inboxDoc.data().challengeId;
                await updateDoc(doc(db, "challenges", chalId), { status: "accepted", roomId: newRoomId, variant: vari });
            }
            await deleteDoc(doc(db, "inbox", inboxId));
            const v = vari === 'crazyhouse' ? 'crazyhouse' : 'game';
            window.location.href = `${v}.html?id=${newRoomId}&side=${mySide}`;
        };

        window.openPrivateChat = (target) => {
            document.getElementById('pChatTarget').innerText = target;
            document.getElementById('pChatOverlay').style.display = 'flex';
            const chatID = [curName, target].sort().join("_");
            if(unsubPChat) unsubPChat();
            unsubPChat = onSnapshot(query(collection(db, "p_chats"), where("chatID", "==", chatID), orderBy("timestamp", "asc")), (s) => {
                const b = document.getElementById('pChatBox'); b.innerHTML = "";
                s.forEach(d => {
                    const m = d.data();
                    b.innerHTML += `<div class="msg-wrap ${m.from === curName ? 'msg-self' : ''}"><div class="msg-content"><div class="msg-bubble">${m.text}</div></div></div>`;
                });
                b.scrollTop = b.scrollHeight;
            });
        };

        window.sendPrivateChat = async () => {
            const t = document.getElementById('pChatIn');
            const target = document.getElementById('pChatTarget').innerText;
            if(!t.value) return;
            const chatID = [curName, target].sort().join("_");
            await addDoc(collection(db, "p_chats"), { chatID, from: curName, to: target, text: t.value, timestamp: Date.now() });
            t.value = "";
        };

        window.sendChat = async () => { 
            const i = document.getElementById('chatIn'); if(i.value.trim()){ 
                await addDoc(collection(db, "chats"), { name: curName, title: myTitle, text: i.value, photo: user.photoURL, timestamp: Date.now() }); i.value = ""; 
            }
        };

        window.startMatchmaking = async () => {
            document.getElementById('searchOverlay').style.display = 'flex';
            document.getElementById('searchTitle').innerText = "Searching...";
            let sec = 0; sInterval = setInterval(() => { sec++; document.getElementById('searchTimer').innerText = `00:${sec < 10 ? '0'+sec : sec}`; }, 1000);
            const q = query(collection(db, "rooms"), where("status", "==", "waiting"), where("timer", "==", timerVal), where("variant", "==", variant), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) {
                roomId = snap.docs[0].id;
                await updateDoc(doc(db, "rooms", roomId), { player2: { name: curName }, status: "playing" });
                goGame(roomId, 'black');
            } else {
                const nr = await addDoc(collection(db, "rooms"), { player1: { name: curName }, status: "waiting", timer: timerVal, variant: variant, createdAt: Date.now() });
                roomId = nr.id;
                unsubRoom = onSnapshot(doc(db, "rooms", roomId), (s) => { if(s.exists() && s.data().status === "playing") goGame(roomId, 'white'); });
            }
        };

        window.cancelSearch = async () => { 
            clearInterval(sInterval); if(unsubRoom) unsubRoom();
            if(roomId) { 
                const rDoc = await getDocs(query(collection(db, "rooms"), where("status", "==", "waiting")));
                rDoc.forEach(async (d) => { if(d.id === roomId) await deleteDoc(doc(db, "rooms", d.id)); });
                roomId = null; 
            }
            document.getElementById('searchOverlay').style.display = 'none';
        };

        function goGame(id, side) { 
            clearInterval(sInterval); if(unsubRoom) unsubRoom(); 
            const v = variant === 'crazyhouse' ? 'crazyhouse' : 'game';
            window.location.href = `${v}.html?id=${id}&side=${side}`; 
        }

        window.openUpdateModal = () => {
            const lv = parseInt(localStorage.getItem('appVersion')) || 0;
            const c = document.getElementById('updateContent');
            if(serverVersion > lv) c.innerHTML = `<h3 style="color:#81b64c">Update Available</h3><button class="btn-gold" onclick="localStorage.setItem('appVersion', ${serverVersion}); location.reload()">UPDATE</button>`;
            else c.innerHTML = `<h3 style="color:#aaa">Update Not Available</h3>`;
            document.getElementById('updateStatusModal').style.display = 'flex'; window.toggleDropdown();
        };

        window.pushUpdate = async () => { await setDoc(doc(db, "config", "settings"), { latestVersion: Date.now() }, { merge: true }); alert("Pushed"); };
        window.sendGlobalNotif = async () => {
            const txt = document.getElementById('notifAllIn').value;
            const us = await getDocs(collection(db, "users"));
            us.forEach(async (u) => { await addDoc(collection(db, "inbox"), { to: u.data().name, type: 'system', text: txt, read: false, timestamp: Date.now() }); });
            alert("Sent!"); closeModals();
        };

        async function checkBanStatus(name) {
            onSnapshot(query(collection(db, "bans"), where("name", "==", name)), (s) => {
                if(!s.empty && Date.now() < s.docs[0].data().expiry) document.getElementById('bannedOverlay').style.display = 'flex';
                else document.getElementById('bannedOverlay').style.display = 'none';
            });
        }

        function loadData() {
            onSnapshot(doc(db, "config", "broadcastMsg"), (d) => {
                const txt = d.exists() ? d.data().text : "Welcome to ChessEloBeth!";
                document.getElementById('bcText').innerText = txt;
            });
            onSnapshot(doc(db, "config", "settings"), (d) => {
                if(d.exists()) {
                    serverVersion = d.data().latestVersion || 0;
                    const lv = parseInt(localStorage.getItem('appVersion')) || 0;
                    const n = document.getElementById('updateNotify');
                    if(serverVersion > lv) { n.innerText = "Update: Available please check \"Update Status\" Menu"; n.style.color = "#81b64c"; }
                    else { n.innerText = "Update: Not Available"; n.style.color = "#aaa"; }
                }
            });
            onSnapshot(query(collection(db, "chats"), orderBy("timestamp", "asc"), limit(50)), (s) => {
                const b = document.getElementById('chatBox'); b.innerHTML = "";
                s.forEach(d => {
                    const m = d.data();
                    b.innerHTML += `<div class="msg-wrap ${m.name === curName ? 'msg-self' : ''}"><img src="${m.photo}" class="msg-ava"><div class="msg-content"><span class="msg-name">${m.title?'['+m.title+']':''}${m.name}</span><div class="msg-bubble">${m.text}</div></div></div>`;
                });
                b.scrollTop = b.scrollHeight;
            });
        }

        window.addAccess = async () => { await setDoc(doc(db, "access", document.getElementById('accName').value), { hasAccess: true }); alert("Done"); };
        window.addTitle = async () => { await setDoc(doc(db, "titles", document.getElementById('titleName').value), { title: document.getElementById('titlePick').value }); alert("Done"); };
        window.banUser = async () => { await setDoc(doc(db, "bans", document.getElementById('banName').value), { name: document.getElementById('banName').value, expiry: Date.now() + 999999999 }); alert("Banned"); };
        window.unbanUser = async () => { await deleteDoc(doc(db, "bans", document.getElementById('unbanName').value)); alert("Unbanned"); };
        window.submitData = async () => { await addDoc(collection(db, "players"), { name: document.getElementById('inName').value, elo: document.getElementById('inElo').value, date: document.getElementById('inDate').value, rank: document.getElementById('inRank').value, timestamp: Date.now() }); closeModals(); };
        window.updateBC = async () => { await setDoc(doc(db, "config", "broadcastMsg"), { text: document.getElementById('bcInput').value }); closeModals(); };
        window.selectAva = async (url) => { await updateProfile(auth.currentUser, { photoURL: url }); location.reload(); };
    </script>
</body>
</html>
