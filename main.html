<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHESSELOBETH - Main</title>
    <style>
        body { background-color: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; }
        header { background: #2d2d2d; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100; }
        .brand { font-weight: bold; color: #ffd700; font-size: 1.2rem; }
        .nav-btns { display: flex; gap: 12px; align-items: center; }
        .icon-btn { background: #333; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; border: 1px solid #444; overflow: hidden; }
        .profile-img-nav { width: 100%; height: 100%; object-fit: cover; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .welcome { font-size: 1.5rem; margin-bottom: 10px; color: #ffd700; }
        .broadcast-box { background: linear-gradient(45deg, #b8860b, #daa520); color: black; padding: 15px; border-radius: 8px; margin-bottom: 30px; font-weight: bold; }
        
        /* Player Card */
        .card { background: #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #ffd700; cursor: pointer; transition: 0.3s; }
        .card:hover { background: #383838; }
        .card h3 { margin: 0; color: #ffd700; }
        .card p { margin: 5px 0; color: #ccc; }
        .detail-info { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #555; font-size: 0.9rem; color: #eee; }
        .btn-link { color: #ffd700; text-decoration: underline; cursor: pointer; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #ffd700; color: black; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 30px; font-weight: bold; cursor: pointer; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* Avatar Selector */
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .avatar-option { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; object-fit: cover; }
        .avatar-option.selected { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; }

        /* Chat UI */
        .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: none; flex-direction: column; z-index: 1000; }
        .chat-header { padding: 15px; background: #2d2d2d; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffd700; }
        .chat-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { display: flex; gap: 10px; max-width: 85%; }
        .msg-right { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #ffd700; }
        .msg-body { background: #333; padding: 10px; border-radius: 10px; }
        .msg-right .msg-body { background: #ffd700; color: black; }
        .msg-name { font-size: 0.7rem; font-weight: bold; margin-bottom: 2px; color: #ffd700; }

        .chat-input-area { padding: 15px; background: #2d2d2d; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 5px; border: none; background: #444; color: white; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 500; }
        .modal { background: #2d2d2d; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 12px; margin: 8px 0; background: #444; border: none; color: white; border-radius: 8px; box-sizing: border-box; }
        .btn-gold { background: #ffd700; color: black; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-red { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-cancel { background: #555; color: white; width: 100%; padding: 10px; border: none; border-radius: 8px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="brand">CHESSELOBETH</div>
        <div class="nav-btns">
            <button class="icon-btn" onclick="toggleChat(true)">ðŸ’¬</button>
            <button class="icon-btn" onclick="openProfileModal()" id="profileBtn">U</button>
        </div>
    </header>

    <div class="container">
        <div class="welcome" id="welcomeMsg">Welcome...</div>
        <div class="broadcast-box" id="broadcastDisplay">Broadcast: Loading...</div>
        <div id="dataFeed"></div>
    </div>

    <div class="fab" id="ownerFab" onclick="openMenu()">+</div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="text-align: center;">
            <h2>Choose Avatar</h2>
            <div class="avatar-grid" id="avatarPicker"></div>
            <button class="btn-gold" style="margin-top:20px; background:#ff4d4d; color:white;" onclick="logout()">[Logout]</button>
            <button class="btn-cancel" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div class="chat-overlay" id="chatOverlay">
        <div class="chat-header"><span>LIVE CHAT</span><button onclick="toggleChat(false)" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button></div>
        <div class="chat-content" id="chatBox"></div>
        <div class="chat-input-area"><input type="text" id="chatInput" placeholder="Tulis pesan..."><button onclick="sendChat()">âž¤</button></div>
    </div>

    <div class="modal-overlay" id="menuModal">
        <div class="modal">
            <h2>Owner Actions</h2>
            <button class="btn-gold" onclick="openAddData()">[Add Data Player]</button>
            <button class="btn-gold" onclick="openBroadcast()">[Update Broadcast]</button>
            <button class="btn-gold" style="background:#ff4d4d; color:white;" onclick="resetChat()">[Clear All Chat]</button>
            <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="addDataModal">
        <div class="modal">
            <h2>New Player</h2>
            <input type="text" id="inpName" placeholder="Full Name">
            <input type="number" id="inpElo" placeholder="Elo Rating">
            <input type="text" id="inpDate" placeholder="Date (e.g. 12 Feb)">
            <select id="inpRank">
                <option value="None">No Title</option><option value="CM">CM</option><option value="FM">FM</option>
                <option value="IM">IM</option><option value="GM">GM</option>
            </select>
            <input type="text" id="inpChessCom" placeholder="chess.com Username">
            <button class="btn-gold" onclick="submitData()">Create</button>
            <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="broadcastModal">
        <div class="modal">
            <h2>Update Broadcast</h2>
            <textarea id="inpBroadcast" rows="3" placeholder="Type here..."></textarea>
            <button class="btn-gold" onclick="submitBroadcast()">Update</button>
            <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, limit, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw",
      authDomain: "chesselobeth.firebaseapp.com",
      projectId: "chesselobeth",
      storageBucket: "chesselobeth.firebasestorage.app",
      messagingSenderId: "829508204106",
      appId: "1:829508204106:web:e8952c359f63d49646d8b3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUsername = "";
    let isOwner = false;
    let userPhotosCache = {};
    let lastChats = [];

    const avatars = [
        "https://i.ibb.co/v6X8XW9/av1.png", "https://i.ibb.co/Y7S6yvP/av2.png",
        "https://i.ibb.co/m0f6mXm/av3.png", "https://i.ibb.co/pW0X1m0/av4.png",
        "https://i.ibb.co/fD8zP9X/av5.png", "https://i.ibb.co/r2G3M5X/av6.png"
    ];

    // 1. DATA SUBMISSION (OWNER)
    window.submitData = async () => {
        const n = document.getElementById('inpName').value;
        const e = document.getElementById('inpElo').value;
        const d = document.getElementById('inpDate').value;
        const r = document.getElementById('inpRank').value;
        const a = document.getElementById('inpChessCom').value;
        if(!n || !e) return alert("Minimal isi Nama & Elo!");
        await addDoc(collection(db, "players"), { name:n, elo:e, date:d, rank:r, chessAccount:a, timestamp:Date.now() });
        closeModals();
    };

    window.submitBroadcast = async () => {
        const txt = document.getElementById('inpBroadcast').value;
        await setDoc(doc(db, "config", "broadcastMsg"), { text: txt });
        closeModals();
    };

    window.deleteData = async (e, id) => {
        e.stopPropagation(); // Biar gak buka detail saat klik hapus
        if(confirm("Hapus data player?")) await deleteDoc(doc(db, "players", id));
    };

    window.resetChat = async () => {
        if(confirm("Hapus semua pesan chat?")) {
            const snap = await getDocs(collection(db, "chats"));
            snap.forEach(async d => await deleteDoc(doc(db, "chats", d.id)));
        }
    };

    // 2. RENDERING PLAYERS (WITH DETAIL TOGGLE)
    window.toggleDetail = (id) => {
        const el = document.getElementById('detail-' + id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    };

    onSnapshot(query(collection(db, "players"), orderBy("timestamp", "desc")), (snap) => {
        const feed = document.getElementById('dataFeed'); feed.innerHTML = "";
        snap.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const delBtn = isOwner ? `<button class="btn-red" onclick="deleteData(event, '${id}')">Delete</button>` : '';
            feed.innerHTML += `
                <div class="card" onclick="toggleDetail('${id}')">
                    <h3>${data.rank !== 'None' ? '['+data.rank+'] ' : ''}${data.name}</h3>
                    <p>Elo: <b>${data.elo}</b> | ${data.date}</p>
                    <div class="detail-info" id="detail-${id}">
                        <p><b>Chess.com Account:</b> 
                           <a class="btn-link" href="https://www.chess.com/member/${data.chessAccount}" target="_blank">
                             ${data.chessAccount || 'Not Provided'}
                           </a>
                        </p>
                        <p><b>Title:</b> ${data.rank}</p>
                        ${delBtn}
                    </div>
                </div>`;
        });
    });

    // 3. AUTH & AVATAR
    window.selectAvatar = async (url) => {
        await updateProfile(auth.currentUser, { photoURL: url });
        await setDoc(doc(db, "users", auth.currentUser.uid), { name: currentUsername, photo: url }, { merge: true });
        location.reload();
    };

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            currentUsername = user.displayName;
            document.getElementById('welcomeMsg').innerText = `Welcome ${currentUsername}`;
            onSnapshot(collection(db, "users"), (snap) => {
                snap.forEach(d => { userPhotosCache[d.data().name] = d.data().photo; });
                renderChats();
            });
            const fallback = `https://ui-avatars.com/api/?name=${currentUsername}&background=555&color=fff`;
            document.getElementById('profileBtn').innerHTML = `<img src="${user.photoURL || fallback}" class="profile-img-nav">`;
            document.getElementById('avatarPicker').innerHTML = avatars.map(url => `
                <img src="${url}" class="avatar-option ${user.photoURL === url ? 'selected' : ''}" onclick="selectAvatar('${url}')">
            `).join('');
            if(currentUsername === "Jovan") { isOwner = true; document.getElementById('ownerFab').style.display = 'flex'; }
        }
    });

    // 4. CHAT SYSTEM
    const renderChats = () => {
        const chatBox = document.getElementById('chatBox');
        if (!chatBox) return; chatBox.innerHTML = "";
        lastChats.forEach(c => {
            const side = c.name === currentUsername ? 'msg-right' : '';
            const photo = userPhotosCache[c.name] || `https://ui-avatars.com/api/?name=${c.name}`;
            chatBox.innerHTML += `
                <div class="msg ${side}">
                    <img src="${photo}" class="msg-avatar">
                    <div class="msg-body"><div class="msg-name">${c.name}</div><div>${c.text}</div></div>
                </div>`;
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    onSnapshot(query(collection(db, "chats"), orderBy("timestamp", "asc"), limit(50)), (snap) => {
        lastChats = []; snap.forEach(d => lastChats.push(d.data())); renderChats();
    });

    window.sendChat = async () => {
        const inp = document.getElementById('chatInput');
        if(!inp.value.trim()) return;
        await addDoc(collection(db, "chats"), { name: currentUsername, text: inp.value, timestamp: Date.now() });
        inp.value = "";
    };

    // 5. UI UTILS
    window.toggleChat = (s) => document.getElementById('chatOverlay').style.display = s ? 'flex' : 'none';
    window.openProfileModal = () => document.getElementById('profileModal').style.display = 'flex';
    window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none');
    window.openMenu = () => document.getElementById('menuModal').style.display = 'flex';
    window.openAddData = () => { closeModals(); document.getElementById('addDataModal').style.display = 'flex'; };
    window.openBroadcast = () => { closeModals(); document.getElementById('broadcastModal').style.display = 'flex'; };
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    onSnapshot(doc(db, "config", "broadcastMsg"), d => { if(d.exists()) document.getElementById('broadcastDisplay').innerText = `Broadcast: ${d.data().text}`; });
</script>
</body>
</html>
