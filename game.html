<!DOCTYPE html>
<html>
<head>
    <title>CHESSELOBETH - Match</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #262421; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        .player-info { width: 100%; max-width: 400px; display: flex; align-items: center; padding: 10px; background: #2d2d2d; border-radius: 8px; margin: 5px 0; justify-content: space-between; }
        .p-avatar { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; border: 1.5px solid #ffd700; }
        .timer-box { background: #1a1a1a; padding: 6px 12px; border-radius: 4px; color: #ffd700; font-family: monospace; font-size: 1.1rem; min-width: 60px; text-align: center; }
        #myBoard { width: 95vw; max-width: 400px; margin: 10px 0; }
        .white-1e1d7 { background-color: #ebecd0 !important; }
        .black-3c85d { background-color: #779556 !important; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:999; }
        .modal { background:#2d2d2d; padding:30px; border-radius:18px; text-align:center; border:2px solid #ffd700; width:280px; }
        .btn-back { background:#81b64c; color:white; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; margin-top:20px; }
    </style>
</head>
<body>

    <div class="player-info">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="oppAvatar" src="" class="p-avatar">
            <span id="oppName">Opponent</span>
        </div>
        <div class="timer-box" id="oppTime">00:00</div>
    </div>

    <div id="myBoard"></div>

    <div class="player-info">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="myAvatar" src="" class="p-avatar">
            <span id="myName">You</span>
        </div>
        <div class="timer-box" id="myTime">00:00</div>
    </div>

    <button onclick="handleResign()" style="width:100%; max-width:400px; padding:10px; color:#ff4d4d; background:none; border:1px solid #ff4d4d; border-radius:5px; margin-top:10px; cursor:pointer;">üè≥Ô∏è Resign</button>

    <div class="modal-overlay" id="gameOverModal">
        <div class="modal">
            <h1 id="winMsg" style="color:#ffd700; margin:0;">Winner</h1>
            <p id="winReason" style="color:#aaa;">by Checkmate</p>
            <button class="btn-back" onclick="window.location.href='main.html'">BACK TO LOBBY</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAkKDbf6qcWvZME8p8wP0gvKKpB8o0RPaw", authDomain: "chesselobeth.firebaseapp.com", projectId: "chesselobeth", storageBucket: "chesselobeth.firebasestorage.app", messagingSenderId: "829508204106", appId: "1:829508204106:web:e8952c359f63d49646d8b3" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('id');
        const mySide = params.get('side');
        
        let game = new Chess();
        let board = null;
        let whiteSeconds, blackSeconds;
        let timerInterval;

        const roomRef = doc(db, "rooms", roomId);

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function startTimerLogic() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (game.turn() === 'w') whiteSeconds--;
                else blackSeconds--;

                document.getElementById('myTime').innerText = formatTime(mySide === 'white' ? whiteSeconds : blackSeconds);
                document.getElementById('oppTime').innerText = formatTime(mySide === 'white' ? blackSeconds : whiteSeconds);

                if(whiteSeconds <= 0 || blackSeconds <= 0) {
                    clearInterval(timerInterval);
                    const winner = whiteSeconds <= 0 ? "Black" : "White";
                    showGameOver(winner, "Time Out");
                }
            }, 1000);
        }

        function onDrop(source, target) {
            if (game.turn() !== (mySide === 'white' ? 'w' : 'b')) return 'snapback';
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (!move) return 'snapback';
            updateDoc(roomRef, { fen: game.fen(), wTime: whiteSeconds, bTime: blackSeconds });
        }

        board = Chessboard('myBoard', { 
            draggable: true, position: 'start', orientation: mySide, onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        onSnapshot(roomRef, (s) => {
            if(!s.exists()) { showGameOver("Opponent", "Resignation"); return; }
            const d = s.data();
            
            // Sync Time
            if(!whiteSeconds) {
                whiteSeconds = d.wTime || d.timer * 60;
                blackSeconds = d.bTime || d.timer * 60;
            } else {
                whiteSeconds = d.wTime;
                blackSeconds = d.bTime;
            }

            game.load(d.fen);
            board.position(d.fen);

            if(d.status === "playing") startTimerLogic();

            const me = mySide === 'white' ? d.player1 : d.player2;
            const opp = mySide === 'white' ? d.player2 : d.player1;
            
            document.getElementById('myName').innerText = me.name;
            document.getElementById('myAvatar').src = me.photo;
            if(opp) {
                document.getElementById('oppName').innerText = opp.name;
                document.getElementById('oppAvatar').src = opp.photo;
            }

            if(game.game_over()) {
                const winner = game.turn() === 'w' ? d.player2.name : d.player1.name;
                showGameOver(winner, "Checkmate");
            }
        });

        function showGameOver(name, reason) {
            clearInterval(timerInterval);
            document.getElementById('winMsg').innerText = name + " Win";
            document.getElementById('winReason').innerText = "by " + reason;
            document.getElementById('gameOverModal').style.display = 'flex';
        }

        window.handleResign = async () => { if(confirm("Resign?")) await deleteDoc(roomRef); };
    </script>
</body>
</html>
